<?php

use Symfony\Component\HttpFoundation\RedirectResponse;

function slack_log_cron() {



  $last_cron_time = \Drupal::state()->get('cron_run_time_slack_log');
//  dump($last_cron_time);

$config = Drupal::config('slack_log.settings');
  $severityLevel = $config->get('min_severity_level');

  $connection =  Drupal::Database();
  $query =  $connection->select('watchdog', 'wd')
    ->condition('wd.severity', $severityLevel, '<')
//     ->condition('wd.timestamp', $last_cron_time, '<')
    ->fields('wd', [
      'wid',
      'uid',
      'severity',
      'type',
      'timestamp',
      'message',
      'variables',]);
  $result = $query->execute()->fetchAll();

  if ($result) {

  $message = '';

  foreach ($result as $row) {

$message = $message . $row->message;

  }

  $config = \Drupal::config('slack.settings');

  $channel = $config->get('slack_channel');
  $username = $config->get('slack_username');

  $response = \Drupal::service('slack.slack_service')->sendMessage($message, $channel, $username);

  if ($response && RedirectResponse::HTTP_OK == $response->getStatusCode()) {
    drupal_set_message(t('Message was successfully sent!'));
  }
  else {
    drupal_set_message(t('Please check log messages for further details'), 'warning');
  }
  }
  $currentTime = \Drupal::time()->getCurrentTime();
  \Drupal::state()->set('cron_run_time_slack_log', $currentTime);

}

